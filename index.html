<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>匿名天中 - 現代化發文應用</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<style>
    :root {
        --primary-color: #FF5733;
        --secondary-color: #C70039;
        --accent-color: #900C3F;
        --background-color: #000000; /* 背景黑色 */
        --text-color: #FFFFFF;
        --button-gradient: linear-gradient(135deg, #FF5733, #900C3F);
        --card-background: #2C2C2C;
        --input-background: #3E3E3E;
        --input-border: #5A5A5A;
        --input-focus: #FF5733;
        --success-color: #28A745;
        --error-color: #DC3545;
    }

    body {
        font-family: 'Noto Sans TC', sans-serif;
        background: var(--background-color);
        color: var(--text-color);
        line-height: 1.7;
        opacity: 0;
        animation: fadeInPage 0.8s forwards;
        position: relative;
        overflow: hidden;
    }

    .fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInPage {
        to { opacity: 1; }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border-left-color: #ffffff;
        animation: spin 1s linear infinite;
    }

    .card {
        background-color: var(--card-background);
        border-radius: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        transition: all 0.4s ease;
    }

    .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.25);
    }

    .toggle-button {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background-color: var(--input-background);
        color: var(--text-color);
        border: 2px solid var(--input-border);
        font-weight: 600;
    }

    .toggle-button.active {
        background: var(--button-gradient);
        color: white;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        transform: translateY(-3px);
    }

    textarea, input[type="text"] {
        background-color: var(--input-background);
        border: 2px solid var(--input-border);
        border-radius: 1rem;
        transition: all 0.4s ease;
        font-size: 1.1rem;
    }

    textarea:focus, input[type="text"]:focus {
        border-color: var(--input-focus);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        outline: none;
        transform: translateY(-2px);
    }

    .submit-button {
        background: var(--button-gradient);
        color: white;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 2rem; /* 圓角 */
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .submit-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(79, 70, 229, 0.3);
    }

    .submit-button:active {
        transform: scale(0.98);
    }

    @media (max-width: 640px) {
        .card {
            border-radius: 1.5rem;
        }
    }

    #mediaPreview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        padding: 1rem;
    }

    #mediaPreview img, #mediaPreview video {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    #mediaPreview img:hover, #mediaPreview video:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .media-upload-area {
        border: 2px dashed var(--primary-color);
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(79, 70, 229, 0.05);
    }

    .media-upload-area:hover {
        border-color: var(--accent-color);
        background: rgba(79, 70, 229, 0.1);
    }

    .upload-icon {
        color: var(--primary-color);
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .upload-button {
        background: var(--button-gradient);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem; /* 圓角 */
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px rgba(79, 70, 229, 0.3);
    }

    .background-animation {
        animation: backgroundAnimation 5s infinite alternate;
    }

    @keyframes backgroundAnimation {
        0% { background-color: var(--primary-color); }
        100% { background-color: var(--accent-color); }
    }

    /* 添加星星背景動畫 */
    .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
    }

    .star {
        position: absolute;
        width: 2px;
        height: 2px;
        background: #ffffff;
        border-radius: 50%;
        animation: twinkle var(--duration) linear infinite;
        opacity: 0;
    }

    @keyframes twinkle {
        0% { opacity: 0; transform: translateY(0); }
        50% { opacity: 1; }
        100% { opacity: 0; transform: translateY(100vh); }
    }
</style>
</head>
<body class="h-full overflow-y-auto">
<div class="stars" id="starsContainer"></div>
<div class="min-h-full flex flex-col">
    <main class="flex-grow py-16 px-4 sm:px-6 lg:px-8">
        <div class="mx-auto max-w-3xl">
            <div class="card p-10 mb-8">
                <h1 class="text-5xl font-bold text-center mb-10 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600">匿名江翠</h1>
                
                <form id="postForm" class="space-y-8 text-center">


                    <div>
                        <label for="postContent" class="block text-xl font-semibold mb-3">分享你的想法</label>
                        <textarea id="postContent" name="postContent" rows="5" class="w-full px-5 py-4 rounded-xl mx-auto border-2 border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-300 ease-in-out transform hover:scale-105" placeholder="寫下你的想法..."></textarea>
                        <p id="charCount" class="mt-3 text-base text-gray-600 font-medium">已輸入 0 字</p>
                    </div>

                    <div>
                        <label class="block text-xl font-semibold mb-3">添加圖片（最多一個檔案）</label>
                        <div class="media-upload-area">
                            <div class="upload-icon">📸</div>
                            <label class="cursor-pointer upload-button">
                                <span class="text-lg font-medium">選擇檔案</span>
                                <input id="postMedia" name="postMedia" type="file" accept="image/*" class="hidden">
                            </label>
                        </div>
                        <div id="mediaPreview" class="mt-6"></div>
                    </div>

                    <div>
                        <button type="submit" id="submitButton" class="submit-button w-full py-4 px-8 text-lg font-bold flex items-center justify-center space-x-3 background-animation">
                            <span>發布貼文</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                            </svg>
                        </button>
                    </div>
                </form>
                <p id="postCount" class="mt-6 text-lg text-gray-400">目前貼文數量：0</p>
            </div>
        </div>
    </main>
</div>

<script>
    // Firebase 配置
    const firebaseConfig = {
  apiKey: "AIzaSyAvviywFxU5-Ia23Hqsl_3ItrsxF6oYLqA",
  authDomain: "ctjh-84ffc.firebaseapp.com",
  projectId: "ctjh-84ffc",
  storageBucket: "ctjh-84ffc.appspot.com",
  messagingSenderId: "81707489957",
  appId: "1:81707489957:web:f8c441380b528d77018b4c",
  measurementId: "G-NM1KMK8HT9"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const postContent = document.getElementById('postContent');
    const charCount = document.getElementById('charCount');
    const submitButton = document.getElementById('submitButton');
    const postMedia = document.getElementById('postMedia');
    const mediaPreview = document.getElementById('mediaPreview');
    const postCount = document.getElementById('postCount');

    function updateCharCount() {
        const currentLength = postContent.value.length;
        charCount.textContent = `已輸入 ${currentLength} 字`;
        
        if (currentLength < 10) {
            charCount.classList.add('text-red-500');
        } else {
            charCount.classList.remove('text-red-500');
        }
    }

    postContent.addEventListener('input', updateCharCount);

    postMedia.addEventListener('change', function(e) {
        handleMediaFiles(e.target.files);
    });

    function handleMediaFiles(files) {
        const totalFiles = mediaPreview.children.length + files.length;
        if (totalFiles > 1) {
            alert('最多只能上傳一個檔案');
            return;
        }

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const mediaElement = document.createElement('img');
                mediaElement.src = e.target.result;
                mediaElement.classList.add('w-full', 'h-full', 'object-cover', 'rounded-xl', 'shadow-lg', 'transition-all');
                const deleteButton = createDeleteButton();
                const container = document.createElement('div');
                container.classList.add('relative');
                container.appendChild(mediaElement);
                container.appendChild(deleteButton);
                mediaPreview.appendChild(container);
            }
            reader.readAsDataURL(file);
        });
    }

    function createDeleteButton() {
        const deleteButton = document.createElement('button');
        deleteButton.innerHTML = '×';
        deleteButton.classList.add('absolute', 'top-2', 'right-2', 'bg-red-500', 'text-white', 'rounded-full', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'text-xl', 'font-bold', 'hover:bg-red-600', 'transition-colors', 'shadow-lg');
        deleteButton.addEventListener('click', function(e) {
            e.preventDefault();
            this.parentElement.remove();
        });
        return deleteButton;
    }

    document.getElementById('postForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const content = postContent.value;
        const mediaFiles = postMedia.files;
        
        if (content.trim().length === 0) {
            alert('請輸入內容');
            return;
        }
        
        submitButton.innerHTML = '<div class="spinner mx-auto"></div>';
        submitButton.disabled = true;
        
        try {
            // 獲取 IP 地址
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipResponse.json();
            const ipAddress = ipData.ip;

            // 處理媒體文件上傳
            const mediaUrls = [];
            for (let i = 0; i < mediaFiles.length; i++) {
                const file = mediaFiles[i];
                const storageRef = storage.ref('media/' + Date.now() + '_' + file.name);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                mediaUrls.push({
                    url: url, 
                    type: 'image'
                });
            }

            // 創建貼文文檔
            await db.collection('posts').add({
                content: content,
                mediaUrls: mediaUrls,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                ipAddress: ipAddress,
                status: 'pending', // 添加狀態欄位
                createdDate: new Date().toISOString() // 添加創建日期
            });

            // 成功處理
            submitButton.innerHTML = '發布成功！';
            submitButton.classList.add('bg-green-500');
            
            const message = document.createElement('div');
            message.className = 'mt-4 p-4 bg-green-50 text-green-700 rounded-xl text-center fade-in font-medium';
            message.textContent = '請耐心等待審核';
            this.insertAdjacentElement('afterend', message);
            
            // 重置表單
            setTimeout(() => {
                this.reset();
                charCount.textContent = '已輸入 0 字';
                charCount.classList.remove('text-red-500');
                submitButton.innerHTML = '發布貼文 <svg class="h-6 w-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>';
                submitButton.disabled = false;
                submitButton.classList.remove('bg-green-500');
                message.remove();
                mediaPreview.innerHTML = '';
            }, 3000);

        } catch (error) {
            console.error("發布失敗: ", error);
            alert('發布失敗，請稍後再試');
            submitButton.innerHTML = '發布貼文';
            submitButton.disabled = false;
        }
    });

    // 生成星星的函數
    function createStars() {
        const container = document.getElementById('starsContainer');
        const starCount = 100; // 星星數量

        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            
            // 隨機位置
            const left = Math.random() * 100;
            star.style.left = `${left}%`;
            
            // 隨機大小
            const size = Math.random() * 3;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            
            // 隨機動畫持續時間
            const duration = 3 + Math.random() * 7;
            star.style.setProperty('--duration', `${duration}s`);
            
            // 隨機延遲開始時間
            const delay = Math.random() * 5;
            star.style.animationDelay = `${delay}s`;
            
            container.appendChild(star);
        }
    }

    // 頁面加載時創建星星
    window.addEventListener('load', createStars);

    // 顯示目前貼文數量
    async function updatePostCount() {
        const snapshot = await db.collection('posts').get();
        postCount.textContent = `目前貼文數量：${snapshot.size}`;
    }

    // 頁面加載時更新貼文數量
    window.addEventListener('load', updatePostCount);
</script>
</body>
</html>
